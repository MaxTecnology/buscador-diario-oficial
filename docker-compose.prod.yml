name: diario-prod

x-app-env: &app-env
  APP_ENV: ${APP_ENV:-production}
  APP_DEBUG: ${APP_DEBUG:-false}
  APP_URL: ${APP_URL}
  APP_KEY: ${APP_KEY}
  APP_LOCALE: ${APP_LOCALE:-pt_BR}
  APP_FALLBACK_LOCALE: ${APP_FALLBACK_LOCALE:-pt_BR}
  LOG_CHANNEL: ${LOG_CHANNEL:-stack}
  LOG_LEVEL: ${LOG_LEVEL:-info}
  TRUSTED_PROXIES: ${TRUSTED_PROXIES:-*}
  DB_CONNECTION: mysql
  DB_HOST: mysql
  DB_PORT: ${DB_PORT:-3306}
  DB_DATABASE: ${DB_DATABASE}
  DB_USERNAME: ${DB_USERNAME}
  DB_PASSWORD: ${DB_PASSWORD}
  DB_QUEUE_RETRY_AFTER: ${DB_QUEUE_RETRY_AFTER:-1200}
  SESSION_DRIVER: ${SESSION_DRIVER:-redis}
  SESSION_LIFETIME: ${SESSION_LIFETIME:-120}
  SESSION_SECURE_COOKIE: ${SESSION_SECURE_COOKIE:-true}
  SESSION_DOMAIN: ${SESSION_DOMAIN:-}
  CACHE_STORE: ${CACHE_STORE:-redis}
  QUEUE_CONNECTION: ${QUEUE_CONNECTION:-redis}
  REDIS_CLIENT: phpredis
  REDIS_HOST: redis
  REDIS_PORT: 6379
  REDIS_PASSWORD: ${REDIS_PASSWORD:-null}
  REDIS_QUEUE_RETRY_AFTER: ${REDIS_QUEUE_RETRY_AFTER:-1200}
  FILESYSTEM_DISK: ${FILESYSTEM_DISK:-local}
  DIARIOS_DISK: ${DIARIOS_DISK:-diarios}
  DIARIOS_KEY: ${DIARIOS_KEY}
  DIARIOS_SECRET: ${DIARIOS_SECRET}
  DIARIOS_REGION: ${DIARIOS_REGION:-us-east-1}
  DIARIOS_BUCKET: ${DIARIOS_BUCKET:-diarios}
  DIARIOS_ENDPOINT: ${DIARIOS_ENDPOINT:-http://minio:9000}
  DIARIOS_URL: ${DIARIOS_URL:-}
  DIARIOS_PUBLIC_ENDPOINT: ${DIARIOS_PUBLIC_ENDPOINT:-}
  DIARIOS_USE_PATH_STYLE: ${DIARIOS_USE_PATH_STYLE:-true}
  AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
  AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
  AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:-us-east-1}
  AWS_BUCKET: ${AWS_BUCKET:-}
  AWS_ENDPOINT: ${AWS_ENDPOINT:-}
  AWS_URL: ${AWS_URL:-}
  AWS_USE_PATH_STYLE_ENDPOINT: ${AWS_USE_PATH_STYLE_ENDPOINT:-true}
  MAIL_MAILER: ${MAIL_MAILER:-log}
  MAIL_HOST: ${MAIL_HOST:-mailpit}
  MAIL_PORT: ${MAIL_PORT:-1025}
  MAIL_USERNAME: ${MAIL_USERNAME:-}
  MAIL_PASSWORD: ${MAIL_PASSWORD:-}
  MAIL_SCHEME: ${MAIL_SCHEME:-}
  MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS:-noreply@example.com}
  MAIL_FROM_NAME: ${MAIL_FROM_NAME:-Diario}
  SCRIBE_ADD_ROUTES: "false"

x-app-base: &app-base
  build:
    context: .
    dockerfile: Dockerfile.prod
  restart: unless-stopped
  environment: *app-env
  depends_on:
    - mysql
    - redis
    - minio
  volumes:
    - app_storage:/var/www/html/storage

services:
  app:
    <<: *app-base
    expose:
      - "80"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1/up || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

  worker:
    <<: *app-base
    command: >
      sh -lc "php artisan queue:work ${QUEUE_CONNECTION:-redis}
      --sleep=3
      --tries=3
      --timeout=${QUEUE_WORKER_TIMEOUT:-900}
      --memory=512
      --max-jobs=500
      --max-time=3600"

  scheduler:
    <<: *app-base
    command: >
      sh -lc "while true; do
      php artisan schedule:run --no-interaction -v;
      sleep 60;
      done"

  mysql:
    image: mysql/mysql-server:8.0
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_ROOT_HOST: '%'
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p\"$$MYSQL_ROOT_PASSWORD\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 10

  minio:
    image: minio/minio:latest
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    expose:
      - "9000"
      - "9001"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:9000/minio/health/ready || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10

  minio-init:
    image: minio/mc:latest
    restart: "no"
    depends_on:
      - minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      DIARIOS_BUCKET: ${DIARIOS_BUCKET:-diarios}
    entrypoint: >
      /bin/sh -c "
      until (wget -q -O- http://minio:9000/minio/health/ready >/dev/null); do
        echo 'Aguardando MinIO...'; sleep 2;
      done &&
      /usr/bin/mc alias set local http://minio:9000 \"$$MINIO_ROOT_USER\" \"$$MINIO_ROOT_PASSWORD\" &&
      /usr/bin/mc mb -p \"local/$$DIARIOS_BUCKET\" || true &&
      /usr/bin/mc anonymous set none \"local/$$DIARIOS_BUCKET\" || true
      "

volumes:
  mysql_data:
  redis_data:
  minio_data:
  app_storage:
